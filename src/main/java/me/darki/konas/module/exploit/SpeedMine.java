package me.darki.konas.module.exploit;

import cookiedragon.eventsystem.Subscriber;
import me.darki.konas.event.events.PacketEvent;
import me.darki.konas.event.events.UpdateEvent;
import me.darki.konas.module.Category;
import me.darki.konas.module.Module;
import me.darki.konas.module.client.KonasGlobals;
import me.darki.konas.setting.Setting;
import me.darki.konas.unremaped.*;
import me.darki.konas.util.CrystalUtils;
import me.darki.konas.util.TimerUtil;
import me.darki.konas.util.rotation.Rotation;
import net.minecraft.block.material.Material;
import net.minecraft.block.state.IBlockState;
import net.minecraft.init.Blocks;
import net.minecraft.init.Items;
import net.minecraft.init.MobEffects;
import net.minecraft.item.ItemEndCrystal;
import net.minecraft.network.play.client.CPacketHeldItemChange;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketPlayerTryUseItemOnBlock;
import net.minecraft.network.play.server.SPacketBlockChange;
import net.minecraft.potion.PotionEffect;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.RayTraceResult;
import net.minecraft.util.math.Vec3d;

public class SpeedMine
extends Module {
    public Setting<Class361> mode = new Setting<>("Mode", Class361.INSTANT);
    public Setting<Class341> type = new Setting<>("Type", Class341.MANUAL);
    public Setting<Float> speed = new Setting<>("Speed", Float.valueOf(0.8f), Float.valueOf(1.0f), Float.valueOf(0.0f), Float.valueOf(0.1f)).visibleIf(this::Method396);
    public Setting<Integer> intensity = new Setting<>("Intensity", 1, 10, 1, 1).visibleIf(this::Method535);
    public Setting<Boolean> fall = new Setting<>("Fall", true).visibleIf(this::Method519);
    public Setting<Boolean> rotate = new Setting<>("Rotate", true).visibleIf(this::Method539);
    public Setting<Boolean> predict = new Setting<>("Predict", true).visibleIf(this::Method987);
    public Setting<Boolean> others = new Setting<>("Others", false).visibleIf(this::Method388);
    public Setting<Boolean> noAnim = new Setting<>("NoAnim", false).visibleIf(this::Method993);
    public Setting<Boolean> strict = new Setting<>("Strict", false).visibleIf(this::Method980);
    public Setting<Boolean> limit = new Setting<>("Limit", false).visibleIf(this::Method992);
    public Setting<Boolean> direction = new Setting<>("Direction", false).visibleIf(this::Method394);
    public Setting<Boolean> crystals = new Setting<>("Crystals", false).visibleIf(this::Method393);
    public Setting<Float> delay = new Setting<>("Delay", Float.valueOf(1.0f), Float.valueOf(5.0f), Float.valueOf(0.0f), Float.valueOf(0.1f)).visibleIf(this::Method973);
    public TimerUtil Field2410 = new TimerUtil();
    public boolean Field2411 = false;
    public boolean Field2412 = false;
    public BlockPos Field2413 = null;
    public EnumFacing Field2414 = null;
    public TimerUtil Field2415 = new TimerUtil();
    public int Field2416 = 2000;
    

    @Override
    public boolean Method396() {
        return this.mode.getValue() == Class361.PACKET;
    }

    public boolean Method394() {
        return this.mode.getValue() == Class361.INSTANT;
    }

    @Subscriber
    public void Method536(SendPacketEvent sendPacketEvent) {
        block1: {
            if (this.mode.getValue() != Class361.INSTANT) {
                return;
            }
            if (!this.predict.getValue().booleanValue() || this.type.getValue() != Class341.AUTOMATIC || !(sendPacketEvent.getPacket() instanceof CPacketPlayerTryUseItemOnBlock) || !((CPacketPlayerTryUseItemOnBlock) sendPacketEvent.getPacket()).getPos().offset(((CPacketPlayerTryUseItemOnBlock) sendPacketEvent.getPacket()).getDirection()).equals(this.Field2413)) break block1;
            this.Field2411 = true;
            this.Field2410.UpdateCurrentTime();
        }
    }

    public boolean Method393() {
        return this.mode.getValue() == Class361.INSTANT && this.type.getValue() == Class341.AUTOMATIC;
    }

    public boolean Method539() {
        return this.mode.getValue() == Class361.INSTANT;
    }

    @Override
    public void onEnable() {
        this.Field2411 = false;
        this.Field2412 = false;
        this.Field2413 = null;
        this.Field2414 = null;
        this.Field2416 = 2000;
    }

    public boolean Method519() {
        return this.mode.getValue() != Class361.INSTANT;
    }

    public boolean Method992() {
        return this.mode.getValue() == Class361.INSTANT;
    }

    public boolean Method538() {
        return SpeedMine.mc.player.getHeldItemOffhand().getItem() == Items.END_CRYSTAL;
    }

    public EnumFacing Method1520(BlockPos blockPos) {
        for (EnumFacing enumFacing : EnumFacing.values()) {
            RayTraceResult rayTraceResult = SpeedMine.mc.world.rayTraceBlocks(new Vec3d(SpeedMine.mc.player.posX, SpeedMine.mc.player.posY + (double) SpeedMine.mc.player.getEyeHeight(), SpeedMine.mc.player.posZ), new Vec3d((double)blockPos.getX() + 0.5 + (double)enumFacing.getDirectionVec().getX() * 1.0 / 2.0, (double)blockPos.getY() + 0.5 + (double)enumFacing.getDirectionVec().getY() * 1.0 / 2.0, (double)blockPos.getZ() + 0.5 + (double)enumFacing.getDirectionVec().getZ() * 1.0 / 2.0), false, true, false);
            if (rayTraceResult == null || !rayTraceResult.typeOfHit.equals(RayTraceResult.Type.BLOCK) || !rayTraceResult.getBlockPos().equals(blockPos)) continue;
            return enumFacing;
        }
        if ((double)blockPos.getY() > SpeedMine.mc.player.posY + (double) SpeedMine.mc.player.getEyeHeight()) {
            return EnumFacing.DOWN;
        }
        return EnumFacing.UP;
    }

    public SpeedMine() {
        super("SpeedMine", Category.EXPLOIT, "FastMine", "FakeHaste", "InstantMine", "InstantBreak");
    }

    @Override
    public void onDisable() {
        block0: {
            if (this.mode.getValue() != Class361.VANILLA) break block0;
            SpeedMine.mc.player.removePotionEffect(MobEffects.HASTE);
        }
    }

    @Subscriber(priority=10)
    public void Method135(UpdateEvent class47) {
        block7: {
            if (this.Field2411 && this.Field2413 != null && this.Field2414 != null && this.mode.getValue() == Class361.INSTANT && this.type.getValue() == Class341.AUTOMATIC && this.Field2410.GetDifferenceTiming(100.0f * this.delay.getValue().floatValue())) {
                SpeedMine.mc.player.swingArm(EnumHand.MAIN_HAND);
                if (this.crystals.getValue().booleanValue()) {
                    int n;
                    int n2 = SpeedMine.mc.player.inventory.currentItem;
                    if (!this.Method538() && (n = CrystalUtils.getSlotEndCrystal()) != -1 && SpeedMine.mc.player.inventory.currentItem != n) {
                        SpeedMine.mc.player.inventory.currentItem = n;
                        SpeedMine.mc.player.connection.sendPacket(new CPacketHeldItemChange(n));
                    }
                    if (this.Method538() || SpeedMine.mc.player.inventory.getCurrentItem() != null && SpeedMine.mc.player.inventory.getCurrentItem().getItem() instanceof ItemEndCrystal) {
                        Class545.Method996(this.Field2413, SpeedMine.mc.player.getPositionVector().add(0.0, (double) SpeedMine.mc.player.getEyeHeight(), 0.0), this.Method538() ? EnumHand.OFF_HAND : EnumHand.MAIN_HAND, this.Method1520(this.Field2413), true);
                    }
                    if (SpeedMine.mc.player.inventory.currentItem != n2) {
                        SpeedMine.mc.player.inventory.currentItem = n2;
                        SpeedMine.mc.player.connection.sendPacket(new CPacketHeldItemChange(n2));
                    }
                }
                SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, this.Field2413, this.direction.getValue() != false ? this.Field2414 : EnumFacing.UP));
                if (this.limit.getValue().booleanValue()) {
                    SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, this.Field2413, this.direction.getValue() != false ? this.Field2414.getOpposite() : EnumFacing.DOWN));
                }
                this.Field2411 = false;
            }
            if (class47.isCanceled() || !Rotation.Method1966()) {
                return;
            }
            if (this.Field2413 == null || this.Field2414 == null || this.Field2415.GetDifferenceTiming(3500.0) || !this.rotate.getValue().booleanValue()) break block7;
            KonasGlobals.INSTANCE.Field1139.Method1942(new Vec3d((double)this.Field2413.getX() + 0.5 + (double)this.Field2414.getDirectionVec().getX() * 0.5, (double)this.Field2413.getY() + 0.5 + (double)this.Field2414.getDirectionVec().getY() * 0.5, (double)this.Field2413.getZ() + 0.5 + (double)this.Field2414.getDirectionVec().getZ() * 0.5));
        }
    }

    public boolean Method535() {
        return this.mode.getValue() == Class361.VANILLA;
    }

    public boolean Method993() {
        return this.mode.getValue() == Class361.INSTANT;
    }

    @Subscriber
    public void Method1846(Class646 class646) {
        if (SpeedMine.mc.player == null || SpeedMine.mc.world == null) {
            return;
        }
        if (this.fall.getValue().booleanValue() && SpeedMine.mc.player.onGround && this.mode.getValue() != Class361.INSTANT && class646.Method1149().equals(SpeedMine.mc.player.getPosition().down())) {
            SpeedMine.mc.player.motionY -= 1.0;
        }
        switch (Class343.Field2636[this.mode.getValue().ordinal()]) {
            case 1: {
                class646.Method451(0);
                SpeedMine.mc.player.addPotionEffect(new PotionEffect(MobEffects.HASTE, 69, this.intensity.getValue().intValue(), true, false));
                break;
            }
            case 2: {
                IBlockState iBlockState = SpeedMine.mc.world.getBlockState(class646.Method1149());
                if (iBlockState.getMaterial() == Material.AIR) break;
                class646.Method294(class646.Method213() + iBlockState.getPlayerRelativeBlockHardness(SpeedMine.mc.player, SpeedMine.mc.world, class646.Method1149()) * this.speed.getValue().floatValue());
                class646.Method451(0);
                break;
            }
            case 3: {
                SpeedMine.mc.player.swingArm(EnumHand.MAIN_HAND);
                if (!this.Method515(class646.Method1149())) break;
                this.Field2415.UpdateCurrentTime();
                if (this.type.getValue() == Class341.MANUAL && class646.Method1149().equals(this.Field2413)) {
                    this.Field2416 = 500;
                    SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                } else {
                    this.Field2416 = 2000;
                    if (this.strict.getValue().booleanValue()) {
                        SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                        SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232().getOpposite() : EnumFacing.DOWN));
                        if (this.noAnim.getValue().booleanValue()) {
                            SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.ABORT_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232().getOpposite() : EnumFacing.DOWN));
                        }
                        SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                    } else {
                        SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.START_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                        if (this.noAnim.getValue().booleanValue()) {
                            SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.ABORT_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                        }
                        SpeedMine.mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.STOP_DESTROY_BLOCK, class646.Method1149(), this.direction.getValue() != false ? class646.Method1232() : EnumFacing.UP));
                    }
                }
                this.Field2413 = class646.Method1149();
                this.Field2414 = class646.Method1232();
                class646.setCanceled(true);
                break;
            }
        }
    }

    public boolean Method973() {
        return this.mode.getValue() == Class361.INSTANT && this.type.getValue() == Class341.AUTOMATIC;
    }

    @Subscriber
    public void Method131(PacketEvent packetEvent) {
        block1: {
            if (this.mode.getValue() != Class361.INSTANT) {
                return;
            }
            if (this.predict.getValue().booleanValue() || this.type.getValue() != Class341.AUTOMATIC || !(packetEvent.getPacket() instanceof SPacketBlockChange) || !((SPacketBlockChange) packetEvent.getPacket()).getBlockPosition().equals(this.Field2413) || ((SPacketBlockChange) packetEvent.getPacket()).getBlockState().getBlock() == Blocks.AIR || !(SpeedMine.mc.player.getDistance((double)((SPacketBlockChange) packetEvent.getPacket()).getBlockPosition().getX() + 0.5, (double)((SPacketBlockChange) packetEvent.getPacket()).getBlockPosition().getY() + 0.5, (double)((SPacketBlockChange) packetEvent.getPacket()).getBlockPosition().getZ() + 0.5) < 6.0) || this.others.getValue().booleanValue() && ((SPacketBlockChange) packetEvent.getPacket()).getBlockState().getBlock().equals(SpeedMine.mc.world.getBlockState(((SPacketBlockChange) packetEvent.getPacket()).getBlockPosition()).getBlock())) break block1;
            this.Field2411 = true;
            this.Field2410.UpdateCurrentTime();
        }
    }

    public boolean Method515(BlockPos blockPos) {
        IBlockState iBlockState = SpeedMine.mc.world.getBlockState(blockPos);
        return iBlockState.getBlockHardness(SpeedMine.mc.world, blockPos) != -1.0f;
    }

    public boolean Method980() {
        return this.mode.getValue() == Class361.INSTANT;
    }

    public boolean Method987() {
        return this.mode.getValue() == Class361.INSTANT && this.type.getValue() == Class341.AUTOMATIC;
    }

    public boolean Method388() {
        return this.mode.getValue() == Class361.INSTANT && this.type.getValue() == Class341.AUTOMATIC;
    }
}